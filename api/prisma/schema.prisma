datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
} 

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

enum EnsNameType {
  ALIAS
  ENS_NAME
}

model Users {
  address       String                     @id
  ens_name      String?
  ens_name_type EnsNameType @default(ENS_NAME) 
  email         String?
  auth_provider String?                    @default("wallet") // "wallet", "google", "facebook", or "hybrid"
  createdAt     DateTime                   @default(now()) @map("created_at")
  updatedAt     DateTime                   @updatedAt @map("updated_at")
  Latest        Latest[]
  Settings      Settings?
  UserAddresses UserAttestationAddresses[]
  OAuthAccounts OAuthAccount[]
  Subscriptions Subscription[]
  UserUsage     UserUsage?

  @@map("users")
}

model UserUsage {
  user_address    String   @id
  storage_usage_bytes BigInt @default(0)
  files_count     Int      @default(0)
  contracts_count Int      @default(0)
  templates_count Int      @default(0)
  updated_at      DateTime @updatedAt

  User            Users    @relation(fields: [user_address], references: [address])
  @@map("user_usage")
}

model AquaTemplate {
  id          String               @id
  owner       String
  title       String
  subtitle    String
  name        String
  created_at  String
  public      Boolean
  createdAt   DateTime             @default(now()) @map("created_at_ts")
  updatedAt   DateTime             @updatedAt @map("updated_at")
  form_fields AquaTemplateFields[]

  @@map("aqua_templates")
}

model VerificationData {
  id           String   @id @default(uuid())
  session      String
  filled_value String
  code         String
  is_used      Boolean  @default(false)
  created_on   DateTime @default(now())
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("verification_data")
}

model AquaTemplateFields {
  id            String   @id @default(uuid())
  aqua_form_id  String
  name          String
  label         String
  type          String
  required      Boolean
  is_array      Boolean  @default(false)
  is_hidden     Boolean  @default(false)
  is_editable   Boolean  @default(true)
  is_verifiable Boolean  @default(false)
  description   String?
  placeholder   String?
  support_text  String?
  default_value String?
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  AquaForm AquaTemplate @relation(fields: [aqua_form_id], references: [id])

  @@map("aqua_templates_fields")
}

model UserAttestationAddresses {
  id          String   @id @default(uuid())
  owner       String
  address     String
  trust_level Int
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  User        Users    @relation(fields: [owner], references: [address])

  @@map("user_attestation_addresses")
}

model SiweSession {
  id             Int       @id @default(autoincrement())
  address        String
  nonce          String    @unique
  issuedAt       DateTime  @default(now())
  expirationTime DateTime?
  provider       String?   @default("wallet") // "wallet", "google", or "facebook"
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  @@map("siwe_session")
}

model OAuthAccount {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  provider      String   // "google" or "facebook"
  providerId    String   @map("provider_id") // Unique ID from OAuth provider
  email         String?
  name          String?
  picture       String?
  accessToken   String?  @map("access_token")
  refreshToken  String?  @map("refresh_token")
  expiresAt     DateTime? @map("expires_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  User          Users    @relation(fields: [userId], references: [address])

  @@unique([provider, providerId])
  @@map("oauth_accounts")
}

model Contract {
  hash                 String   @id
  genesis_hash         String?
  latest               String?
  sender               String?
  recipients           String[]
  option               String?
  reference_count      Int?
  file_name            String?
  receiver_has_deleted String[]
  created_at           DateTime @default(now())
  createdAt            DateTime @default(now()) @map("created_at_ts")
  updatedAt            DateTime @updatedAt @map("updated_at")

  @@map("contract")
}

model Latest {
  hash        String   @id
  user        String
  template_id String?
  is_workflow Boolean  @default(false)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  User        Users    @relation(fields: [user], references: [address])

  @@map("latest")
}

model Revision {
  pubkey_hash         String      @id
  nonce               String?
  file_hash           String?
  shared              String[]
  contract            String[]
  previous            String?
  children            String[]
  local_timestamp     String?
  revision_type       String?
  has_content         Boolean     @default(false)
  verification_leaves String[]
  createdAt           DateTime    @default(now()) @map("created_at")
  updatedAt           DateTime    @updatedAt @map("updated_at")
  Signature           Signature[]
  Witness             Witness[]
  Link                Link[]
  AquaForms           AquaForms[]

  @@map("revision")
}

model File {
  file_hash     String   @id
  file_location String
  file_size     Int      @default(0)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("file")
}

model FileIndex {
  file_hash   String   @id
  pubkey_hash String[]
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("file_index")
}

model FileName {
  pubkey_hash String   @id
  file_name   String
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("file_name")
}

model Link {
  hash                              String   @id
  link_type                         String?
  link_require_indepth_verification Boolean?
  link_verification_hashes          String[]
  reference_count                   Int?
  link_file_hashes                  String[]
  createdAt                         DateTime @default(now()) @map("created_at")
  updatedAt                         DateTime @updatedAt @map("updated_at")
  Revision                          Revision @relation(fields: [hash], references: [pubkey_hash])

  @@map("link")
}

model Signature {
  hash                     String   @id
  signature_digest         String?
  signature_wallet_address String?
  signature_public_key     String?
  signature_type           String?
  reference_count          Int?
  createdAt                DateTime @default(now()) @map("created_at")
  updatedAt                DateTime @updatedAt @map("updated_at")
  Revision                 Revision @relation(fields: [hash], references: [pubkey_hash])

  @@map("signature")
}

model Witness {
  hash                String        @id
  Witness_merkle_root String?
  reference_count     Int?
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")
  Revision            Revision      @relation(fields: [hash], references: [pubkey_hash])
  WitnessEvent        WitnessEvent? @relation(fields: [Witness_merkle_root], references: [Witness_merkle_root])

  @@map("witness")
}

model WitnessEvent {
  Witness_merkle_root            String    @id
  Witness_timestamp              String?
  Witness_network                String?
  Witness_smart_contract_address String?
  Witness_transaction_hash       String?
  Witness_sender_account_address String?
  createdAt                      DateTime  @default(now()) @map("created_at")
  updatedAt                      DateTime  @updatedAt @map("updated_at")
  Witness                        Witness[]

  @@map("witness_event")
}

model AquaForms {
  id              String   @id @default(uuid())
  hash            String
  key             String?
  value           Json?
  type            String?
  reference_count Int?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  Revision        Revision @relation(fields: [hash], references: [pubkey_hash])

  @@map("aqua_forms")
}

model MerkleNodes {
  node_hash        String   @id
  parent_hash      String?
  height           Int?
  is_leaf          Boolean?
  left_child_hash  String?
  right_child_hash String?
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@map("merkle_nodes")
}

model Settings {
  user_pub_key             String   @id
  cli_pub_key              String?
  cli_priv_key             String?
  alchemy_key              String   @default("ZaQtnup49WhU7fxrujVpkFdRz4JaFRtZ")
  witness_network          String?
  witness_contract_address String?
  theme                    String?
  createdAt                DateTime @default(now()) @map("created_at")
  updatedAt                DateTime @updatedAt @map("updated_at")
  User                     Users    @relation(fields: [user_pub_key], references: [address])

  @@map("settings")
}

model Notifications {
  id          String   @id @default(uuid())
  sender      String
  receiver    String
  content     String
  is_read     Boolean  @default(false)
  created_on  DateTime @default(now())
  navigate_to String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("notifications")
}

model VerificationAttempt {
  id                    Int      @id @default(autoincrement())
  email_or_phone_number String
  verification_type     String
  nonce                 String?
  action                String
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@index([email_or_phone_number, verification_type, action])
}

model DNSClaimVerification {
  id                  Int      @id @default(autoincrement())
  wallet_address      String
  domain              String
  verification_logs   Json
  verification_status String
  is_verified         Boolean  @default(false)
  is_domain_verified  Boolean  @default(true)
  last_verified       DateTime
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  @@index([wallet_address, domain], name: "wallet_address_domain")
}

model ENSName {
  id             String   @id @default(uuid())
  wallet_address String
  ens_name       String
  ens_expiry     DateTime?
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@index([wallet_address, ens_name], name: "wallet_address_ens_name")
}

// ============================================================================
// PAYMENT SYSTEM MODELS
// ============================================================================

model SubscriptionPlan {
  id                   String         @id
  name                 String         @unique // "Free", "Pro", "Enterprise"
  display_name         String // "Free Plan", "Professional Plan"
  description          String?
  price_monthly_usd    Decimal        @default(0) @db.Decimal(10, 2)
  price_yearly_usd     Decimal        @default(0) @db.Decimal(10, 2)
  stripe_monthly_price_id String?     @unique // Stripe Price ID for monthly billing
  stripe_yearly_price_id  String?     @unique // Stripe Price ID for yearly billing
  crypto_monthly_price_usd Decimal?   @db.Decimal(10, 2)
  crypto_yearly_price_usd  Decimal?   @db.Decimal(10, 2)

  // Plan limits and features
  max_storage_gb       Int            @default(1) // Storage limit in GB
  max_files            Int            @default(100) // File count limit
  max_contracts        Int            @default(10) // Contract limit
  max_templates        Int            @default(5) // Template limit
  features             Json           @default("{}") // Feature flags JSON

  // Plan ordering and visibility
  sort_order           Int            @default(0) // For display ordering
  is_active            Boolean        @default(true)
  is_public            Boolean        @default(true) // Show in pricing page

  createdAt            DateTime       @default(now()) @map("created_at")
  updatedAt            DateTime       @updatedAt @map("updated_at")

  subscriptions        Subscription[]

  @@map("subscription_plans")
}

model Subscription {
  id                      String             @id @default(uuid())
  user_address            String
  plan_id                 String
  status                  SubscriptionStatus @default(ACTIVE)
  payment_method          PaymentMethod      // STRIPE or CRYPTO
  billing_period          BillingPeriod      @default(MONTHLY) // MONTHLY or YEARLY

  // Stripe fields
  stripe_customer_id      String?
  stripe_subscription_id  String?            @unique
  stripe_payment_method_id String?

  // Crypto fields
  crypto_payment_id       String?
  crypto_currency         String? // "BTC", "ETH", "USDT", etc.
  crypto_last_payment_hash String? // Last successful transaction hash

  // Subscription period
  current_period_start    DateTime
  current_period_end      DateTime
  cancel_at_period_end    Boolean            @default(false)
  canceled_at             DateTime?
  trial_start             DateTime?
  trial_end               DateTime?

  // Metadata
  metadata                Json?              @default("{}")

  createdAt               DateTime           @default(now()) @map("created_at")
  updatedAt               DateTime           @updatedAt @map("updated_at")

  User                    Users              @relation(fields: [user_address], references: [address], onDelete: Cascade)
  Plan                    SubscriptionPlan   @relation(fields: [plan_id], references: [id])
  payments                Payment[]
  usageRecords            UsageRecord[]

  @@index([user_address])
  @@index([stripe_customer_id])
  @@index([status])
  @@index([current_period_end])
  @@map("subscriptions")
}

model Payment {
  id                       String        @id @default(uuid())
  subscription_id          String
  amount                   Decimal       @db.Decimal(10, 2)
  currency                 String        // "USD", "BTC", "ETH", "USDT", etc.
  payment_method           PaymentMethod
  status                   PaymentStatus @default(PENDING)

  // Stripe fields
  stripe_payment_intent_id String?       @unique
  stripe_invoice_id        String?
  stripe_charge_id         String?

  // Crypto (NOWPayments) fields
  crypto_transaction_hash  String?
  crypto_payment_address   String? // Payment address provided to user
  nowpayments_payment_id   String?       @unique // NOWPayments payment ID
  nowpayments_order_id     String? // Merchant order ID
  crypto_amount            Decimal?      @db.Decimal(20, 8) // Actual crypto amount
  crypto_network           String? // "BTC", "ETH", "TRX", etc.

  // Payment timing
  paid_at                  DateTime?
  failed_at                DateTime?
  refunded_at              DateTime?

  // Error tracking
  failure_code             String?
  failure_message          String?

  // Receipt and invoice
  receipt_url              String?
  invoice_pdf_url          String?

  // Metadata
  metadata                 Json?         @default("{}")

  createdAt                DateTime      @default(now()) @map("created_at")
  updatedAt                DateTime      @updatedAt @map("updated_at")

  Subscription             Subscription  @relation(fields: [subscription_id], references: [id], onDelete: Cascade)

  @@index([subscription_id])
  @@index([status])
  @@index([payment_method])
  @@index([createdAt])
  @@index([stripe_payment_intent_id])
  @@index([nowpayments_payment_id])
  @@map("payments")
}

model UsageRecord {
  id              String       @id @default(uuid())
  subscription_id String
  user_address    String

  // Usage metrics
  storage_used_bytes BigInt    @default(0) // Storage in bytes
  files_count        Int       @default(0)
  contracts_count    Int       @default(0)
  templates_count    Int       @default(0)

  // Timestamp for tracking
  recorded_at     DateTime     @default(now())
  period_start    DateTime
  period_end      DateTime

  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  Subscription    Subscription @relation(fields: [subscription_id], references: [id], onDelete: Cascade)

  @@index([subscription_id])
  @@index([user_address])
  @@index([recorded_at])
  @@map("usage_records")
}

model WebhookEvent {
  id              String        @id @default(uuid())
  source          WebhookSource // STRIPE or NOWPAYMENTS
  event_type      String // e.g., "payment_intent.succeeded", "invoice.paid"
  event_id        String        @unique // External event ID
  payload         Json // Full webhook payload
  processed       Boolean       @default(false)
  processed_at    DateTime?
  error_message   String?
  retry_count     Int           @default(0)

  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  @@index([source, event_type])
  @@index([processed])
  @@index([createdAt])
  @@map("webhook_events")
}

// Enums for payment system
enum SubscriptionStatus {
  ACTIVE        // Subscription is active
  PAST_DUE      // Payment failed, grace period
  CANCELED      // Canceled by user or admin
  TRIALING      // In trial period
  INCOMPLETE    // Initial payment pending
  PAUSED        // Temporarily paused
  EXPIRED       // Trial or subscription expired
}

enum PaymentMethod {
  STRIPE        // Credit/debit card via Stripe
  CRYPTO        // Cryptocurrency via NOWPayments
}

enum PaymentStatus {
  PENDING       // Payment initiated, awaiting confirmation
  PROCESSING    // Payment being processed
  SUCCEEDED     // Payment successful
  FAILED        // Payment failed
  CANCELED      // Payment canceled
  REFUNDED      // Payment refunded
  PARTIALLY_PAID // Crypto payment partially received
}

enum BillingPeriod {
  MONTHLY
  YEARLY
}

enum WebhookSource {
  STRIPE
  NOWPAYMENTS
}
